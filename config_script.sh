#! /bin/bash

echo "---------------------------------------------------------------------------------------------"
echo "-------------------------- Ansible Playbook to Configure K8-master and docker ---------------"
echo "---------------------------------------------------------------------------------------------"
ansible-playbook -i /etc/ansible/ELK_stack_automation/hosts k8_playbook.yml 
echo "---------------------------------------------------------------------------------------------"
echo "---------------------------------------------------------------------------------------------"

echo "---------------------------------------------------------------------------------------------"
echo "------------ Ansible Playbook to Configure K8-nodes and docker on worker nodes --------------"
echo "---------------------------------------------------------------------------------------------"
ansible-playbook -i /etc/ansible/ELK_stack_automation/hosts k8_worker_nodes.yml
echo "---------------------------------------------------------------------------------------------"
echo "---------------------------------------------------------------------------------------------"
kubectl get nodes 2> file

if [ $(cat file | awk '{print$1}') = 'error:' ]
then
  echo "Error Occured!"
  echo "----------------------- Reset Kubeadm ----------------------"
  echo y | kubeadm reset 
  echo "----------------------- Initializing Kubeadm ---------------"
  v=$(kubeadm init)
  echo "$v"
  echo "$v" > kubeadm_init
  echo "----------------------- Setting cluster as a root user ----"
  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config
  echo "-----------------------------------------------------------"
  echo "----------------------- Kubectl Nodes ---------------------"
  echo "-----------------------------------------------------------"
  output=$(kubectl get nodes)
  echo "$output"
  echo "-----------------------------------------------------------"
  echo "-----------------------------------------------------------"
  export kubever=$(kubectl version | base64 | tr -d '\n')
  kubectl apply -f "https://cloud.weave.works/k8s/net?k8s-version=$kubever"
  echo "-----------------------------------------------------------"
  echo "----------------------- Kubectl Pods ----------------------"
  echo "-----------------------------------------------------------"
  output=$(kubectl get pods --all-namespaces)
  echo "$output"
  echo "-----------------------------------------------------------"
  echo "-----------------------------------------------------------"

else
  echo "Successfully running"
  echo "-----------------------------------------------------------"
  echo "----------------------- Kubectl Nodes ---------------------"
  echo "-----------------------------------------------------------"
  output=$(kubectl get nodes)
  echo "$output"
  echo "-----------------------------------------------------------"
  echo "-----------------------------------------------------------"
  echo "-----------------------------------------------------------"
  echo "----------------------- Kubectl Pods ----------------------"
  echo "-----------------------------------------------------------"
  output=$(kubectl get pods --all-namespaces)
  echo "$output"
  echo "-----------------------------------------------------------"
  echo "-----------------------------------------------------------"
fi
